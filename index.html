<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Phalcon + AngularJSで作る動画プラットフォーム</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<!-- <link rel="stylesheet" href="css/theme/default.css" id="theme"> -->
		<!-- <link rel="stylesheet" href="css/theme/moon.css" id="theme"> -->
		<!-- <link rel="stylesheet" href="css/theme/sky.css" id="theme"> -->
		<!-- <link rel="stylesheet" href="css/theme/serif.css" id="theme"> -->
		<link rel="stylesheet" href="css/theme/simple.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1 style="font-size:2.1em;">Phalcon + AngularJSで作る<br>動画プラットフォーム</h1>
					<p>Phalcon Night</p>
					<p>アシアル株式会社 宇都宮諒</p>
				</section>

				<section>
					<h2>自己紹介</h2>
				</section>

				<section>
					<p>宇都宮諒</p>
					<ul>
						<li>アシアル株式会社 所属</li>
						<li>PHPエンジニア</li>
					</ul>
					<img src="img/asial_blog.png" alt="">
				</section>

				<section>
					<h3>アジェンダ</h3>
					<ul>
						<li>アプリケーション概要</li>
						<li>アーキテクチャ</li>
						<li>アプリケーション設計</li>
						<li>Phalconを使う上での工夫・苦労</li>
					</ul>
				</section>

				<section>
					<h3>アプリケーション概要</h3>
					<ul>
						<li>様々な動画を会社等の組織内で共有したい</li>
						<li>動画の一部を切り出したり、プレイリストを作ったりしたい</li>
						<li>動画は、Web及びアプリで視聴したい</li>
						<li>既存システムを全面的に改修したい</li>
					</ul>
				</section>

				<section>
					<h2>アーキテクチャ</h2>
				</section>

				<section>
					<h3>インフラ</h3>
					<p>Azure</p>
					<img src="" alt="azureのロゴとか">
				</section>

				<section>
					<h3>動画関係</h3>
					<ul>
						<li>このアプリケーションで最も重要なのは、「動画配信をどうするか」「動画編集をどうするか」ということ</li>
						<li>動画の問題に比べれば、サーバサイドが何で出来ているかというのは大した問題ではない</li>
						<li>当初はAzureのサービス活用を検討したけど、諸事情で取りやめに</li>
						<li>結果的には、「mp4で配信」「ffmpegでエンコード」という形式に落ち着いた</li>
					</ul>
				</section>

				<section>
					<h3>サーバ構成</h3>
					<ul>
						<li>Web+DBサーバ: 1台</li>
						<li>エンコードサーバー: 複数台</li>
					</ul>
					<p>今のところ負荷は大きくないので、Web+DBは1サーバに集約している。</p>
					<p>エンコードはマシンパワーが必要なので、サービスイン当初から複数台構成で。</p>
				</section>

				<section>
					<h3>システム構成</h3>
					<ul>
						<li>CentOS</li>
						<li>Apache</li>
						<li>MySQL</li>
						<li>PHP</li>
					</ul>
					<p>要は、よくあるLAMP構成。<br>既存システムの構成をそのまま流用。</p>
				</section>

				<section>
					<h3>アプリケーション構成</h3>
					<p>「Web API + クライアントは色々」 最近よくあるやつ</p>
					<ul>
						<li>動画編集機能(AngularJS)</li>
						<li>動画配信Web(vue.jsとか)</li>
						<li>動画配信アプリ(Web APIを叩いてデータ取得)</li>
						<li>バックエンドWeb API(Phalcon)</li>
					</ul>
					<p>viewの描画は基本的にクライアントに任せる。<br>
						クライアントがカバーできない部分（多言語対応等）をPHPで補う。</p>
				</section>

				<section>
					<h3>Phalconを選んだ理由</h3>
					<ul>
						<li>動作が速い</li>
						<li>アーキテクチャが割とモダン(PHP5.3+)</li>
						<li>シンプルなAPI</li>
						<li>学習コストが低め（要：英語）</li>
					</ul>
				</section>

				<section>
					<h3>工夫したこと：モデルの構成</h3>
				</section>

				<section>
					<h3>プロジェクトタイプ</h3>
					<ul>
						<li>micro / simple / modules がある</li>
						<li>今回のアプリでは、modules構成を使用</li>
					</ul>
					<pre><code>
$ phalcon project PROJECT_NAME --type=modules
					</code></pre>
				</section>

				<section>
					<h3>ディレクトリ構成</h3>
					<pre><code>
├── apps
│   ├── editor
│   │   ├── config
│   │   ├── controllers
│   │   ├── models
│   │   └── views
│   └── viewer
│       ├── config
│       ├── controllers
│       ├── models
│       └── views
├── config
├── models
│   └── Base
├── public
├── tasks
├── tests
└── vendor
					</code></pre>
					<p>コマンドによる生成直後のmodules構成は、モデルがモジュールごとに分かれているが、共通モデルはアプリケーションルート直下のmodelsにまとめた。
						<br>各モジュールのmodelsにはフォーム等、モジュール固有のクラスを入れてある。</p>
				</section>

			<section>
				<h3>DBスキーマ</h3>
				<p>以下の手順でDBスキーマとモデルクラスの管理を行った。</p>
				<ol>
					<li><a href="http://www-jp.mysql.com/products/workbench/">MySQL Workbench</a>でER図作成</li>
					<li>WorkbenchのForward Engineer機能でスキーマ定義のSQL文を生成</li>
					<li>スキーマ定義SQLを使用してDBにテーブル作成</li>
					<li>DBに存在するテーブルを元に、phalcon modelコマンドでBaseモデルを生成</li>
				</ol>

			</section>

			<section>
				<h3>Baseモデルとは？</h3>
				<ul>
					<li>DBスキーマを更新したら、Baseモデルも全て作り直す。</li>
					<li>Baseモデルは自動生成を行う。開発者はBaseモデルには触らない。</li>
					<li>symfony 1(doctrine 1)の経験者には馴染みやすい考え方。</li>
					<li>モデルに共通で持たせたい処理（ビヘイビア等）はBaseモデルの親(CoreModel)に実装する。</li>
					<li>CoreModelは、Phalcon\Mvc\Model を継承する。</li>
					<li>アプリケーション内で使用するモデルは、Baseモデルを継承する。</li>
					<li>Baseモデルの生成は以下のようなコマンドで行う。</li>
				</ul>
				<pre><code>
					phalcon model --namespace=App\\Models\\Base --extends=\\App\\Models\\CoreModel --name=TABLE_NAME
				</code></pre>
			</section>

			<section>
				<h3>苦労したこと(1)：フレームワーク本体のバグ</h3>
			</section>

			<section>
				<h3>Phalcon使用時に遭遇する特徴的なエラーメッセージ</h3>
				<ul>
					<li>zend_mm_heap corrupted</li>
					<li>Segmentation fault</li>
				</ul>
			</section>

			<section>
				<h3>苦労したこと(2)：ドキュメント</h3>
			</section>

			<section>
				<h3>Phalconのドキュメントの弱点(1): APIリファレンス</h3>
				<ul>
					<li>PhalconのAPIリファレンスは自動生成。ソースコードのコメントが誤っているとAPIリファレンスまでおかしくなる。</li>
					<li>自動生成スクリプトにバグがあり、正常にパラメータを取れていないことがある</li>
					<li>例：Phalcon\Http\Request::getJsonRawBody()の第2引数は、ソースのDocコメントには載っているが、APIリファレンスには載っていない</li>
				</ul>
			</section>

			<section>
				<h3>Phalconのドキュメントの弱点(2): 翻訳</h3>
				<ul>
					<li>Phalconのドキュメントで日本語になっているのは、全体の10%程度。</li>
					<li>実は、20%ほど翻訳は進んでいるのだけど、リリースされていない。。。</li>
					<li>翻訳に興味の有る方いらっしゃれば是非。</li>
				</ul>
			</section>

			<section>
				<h3>まとめ</h3>
			</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Parallax scrolling
				// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
